---
- name: "Play to create hetzner cloud servers"
  hosts: all
  connection: local
  gather_facts: false

  tasks:
    - name: "Interact with hcloud to create cloud servers"
      ansible.builtin.include_tasks: "tasks/hetzner-cloud.yaml"

- name: "Play to configure servers"
  hosts: all
  tasks:
    - name: "Create low privileged user account"
      ansible.builtin.include_tasks: "tasks/create-worker-user.yaml"

    - name: "Remove labels from cloud server {{ inventory_hostname }}"
      hetzner.hcloud.hcloud_server:
        api_token: "{{ hcloud_api_token }}"

        name: "{{ inventory_hostname }}"
        labels: {}

        state: present
      when: new_server
      delegate_to: localhost

    - name: "Configure sshd"
      ansible.builtin.include_role:
        name: "ansible-role-sshd"

    - name: "Update repositories cache on systems using apt"
      ansible.builtin.apt:
        update_cache: true
      when: ansible_pkg_mgr == 'apt'
      changed_when: false
      become: true

    - name: "Install extra packages for enterprise linux"
      ansible.builtin.package:
        name: epel-release
        state: present
      when: "ansible_distribution in ['CentOS', 'AlmaLinux', 'Rocky']"
      become: true

    - name: "Setup fail2ban"
      ansible.builtin.include_role:
        name: "ansible-role-fail2ban"

    - name: "Configure automatic updates of installed packages"
      ansible.builtin.include_tasks: "tasks/auto-update.yaml"

    # - name: "Install unattended upgrades"
    #   ansible.builtin.apt:
    #     name:
    #       - python3-requests
    #       - python3-apt
    #       - curl
    #       - wget
    #       - dnsutils
    #       - mtr
    #       - tcpdump
    #       - ncdu
    #       - jq
    #       - iptables
    #       - iptables-persistent
    #     state: present
    #   become: true

    - name: "Setup nginx"
      ansible.builtin.include_role:
        name: "ansible-role-nginx"
      when:
        - enable_ipv4  # otherwise acme.sh cannot be installed
        - install_nginx
