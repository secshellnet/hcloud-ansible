---
- name: "Play to create hetzner cloud servers"
  hosts: all
  connection: local
  gather_facts: false

  tasks:
    - name: "Interact with hcloud to create cloud servers"
      ansible.builtin.include_tasks: "tasks/hetzner-cloud.yaml"

- name: "Play to configure servers"
  hosts: all
  tasks:
    - name: "Create low privileged user account"
      ansible.builtin.include_tasks:
        file: "tasks/linux/create-worker-user.yaml"

    - name: "Remove labels from cloud server"
      when:
        - "new_server"
      hetzner.hcloud.server:
        api_token: "{{ hcloud_api_token }}"

        name: "{{ inventory_hostname }}"
        labels: {}

        state: present
      delegate_to: localhost

    - name: "Configure sshd"
      tags: [hardening]
      ansible.builtin.include_role:
        name: "ansible-role-sshd"
        apply:
          tags: [hardening]

    - name: "Update repositories cache on systems using apt"
      when:
        - "ansible_pkg_mgr == 'apt'"
      ansible.builtin.apt:
        update_cache: true
      changed_when: false
      become: true

    - name: "Install extra packages for enterprise linux"
      when:
        - "ansible_distribution in ['CentOS', 'AlmaLinux', 'Rocky']"
      ansible.builtin.package:
        name: epel-release
        state: present
      become: true

    - name: "Setup fail2ban"
      tags: [hardening]
      ansible.builtin.include_tasks:
        file: "tasks/linux/setup-fail2ban.yaml"
        apply:
          tags: [hardening]

    - name: "Configure automatic updates of installed packages"
      tags: [hardening]
      ansible.builtin.include_tasks:
        file: "tasks/linux/setup-auto-update.yaml"
        apply:
          tags: [hardening]

    # - name: "Setup clamav"
    #   tags: [hardening]
    #   ansible.builtin.include_tasks:
    #     file: "tasks/linux/setup-clamav.yaml"
    #     apply:
    #       tags: [hardening]

    # TODO setup local firewall rules (outgoing is more important than ingoing (because this can be controlled using the port bindings))
    # TODO setup auditd
    # TODO setup aide
    # TODO setup IDS (Suricata / snort)?
    # TODO setup LSM (e.g. selinux, apparmor)
    # TODO setup agent / sidecar for wazuh / elastic / graylog / ... or sent at least logs via syslog but agent would be better
    # TODO think about backup

    # - name: "Audit the system using openscap"
    #   tags: [auditing]
    #   block:
    # Packages on debian: openscap-scanner ssg-debian
    # TODO openscap on each platform at least once (maybe even automaticly and download results when enabled)

    - name: "Setup postgresql"
      when:
        - "install_postgresql"
      tags: [postgresql]
      block:
        # Note: The passwords of postgresql users are not being stored with the
        #       other (e.g. database) settings in the host_vars/<hostname>/vars.yaml
        #       for security reasons. Instead the are stored in the vault of the host
        #       (host_vars/<hostname>/vault) and will be merged by the following task.
        - name: "Merge PostgreSQL users variables with passwords from vault"
          ansible.builtin.set_fact:
            postgresql_users: "{{ postgresql_users | default([]) + [item_u | combine(item_e)] }}"
          loop: "{{ postgresql_users_u | default([]) }}"
          loop_control:
            loop_var: item_u
          vars:
            item_e: "{{ postgresql_users_e | selectattr('name', '==', item_u.name) | first }}"

        - name: "Install postgresql using ansible-role"
          ansible.builtin.include_role:
            name: "geerlingguy.postgresql"
            apply:
              become: true
              tags: [postgresql]

    - name: "Setup redis"
      when:
        - "install_redis"
      tags: [redis]
      ansible.builtin.include_role:
        name: "geerlingguy.redis"
        apply:
          become: true
          tags: [redis]

    # TODO describe how to deploy containers with applications (make an example here)
